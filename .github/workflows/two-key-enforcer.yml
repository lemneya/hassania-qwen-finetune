name: Two-Key Enforcer

on:
  pull_request_review:
    types: [submitted]
  pull_request:
    branches: [ "main" ]

jobs:
  check-two-key:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if sensitive paths are touched
        id: check-sensitive
        run: |
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD 2>/dev/null || echo "")
          
          # Define sensitive path patterns
          SENSITIVE_PATTERNS="^ops/|^gates/|^\.github/workflows/|^security/|^deploy/|^infra/|\.env|secrets/"
          
          # Check if any sensitive files are touched
          SENSITIVE_TOUCHED="false"
          for file in $CHANGED_FILES; do
            if echo "$file" | grep -qE "$SENSITIVE_PATTERNS"; then
              echo "Sensitive file touched: $file"
              SENSITIVE_TOUCHED="true"
            fi
          done
          
          echo "sensitive_touched=$SENSITIVE_TOUCHED" >> $GITHUB_OUTPUT
          echo "Sensitive paths touched: $SENSITIVE_TOUCHED"

      - name: Enforce Two-Key Approval for Sensitive Paths
        if: steps.check-sensitive.outputs.sensitive_touched == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            
            // Get unique approvers (excluding the PR author)
            const prAuthor = context.payload.pull_request.user.login;
            const approvers = new Set();
            
            for (const review of reviews) {
              if (review.state === 'APPROVED' && review.user.login !== prAuthor) {
                approvers.add(review.user.login);
              }
            }
            
            console.log(`PR Author: ${prAuthor}`);
            console.log(`Approvers: ${Array.from(approvers).join(', ')}`);
            console.log(`Number of unique approvers: ${approvers.size}`);
            
            // Check for sensitive paths in PR body (Risk Level)
            const body = context.payload.pull_request.body || "";
            const isL2orL3 = /Risk Level.*L[23]/i.test(body) || /مستوى المخاطر.*L[23]/i.test(body);
            
            if (isL2orL3) {
              console.log("This PR is marked as L2 or L3 (sensitive/critical)");
              if (approvers.size < 2) {
                core.setFailed(`Two-Key Enforcement: L2/L3 PRs touching sensitive paths require 2 distinct approvers. Current: ${approvers.size}`);
                return;
              }
              console.log("✅ Two-Key requirement satisfied!");
            } else {
              // Even if not marked L2/L3, warn if touching sensitive paths
              console.log("⚠️ Warning: This PR touches sensitive paths but is not marked as L2/L3.");
              console.log("Consider updating the Risk Level in the PR description.");
              if (approvers.size < 1) {
                core.setFailed("PRs touching sensitive paths require at least 1 approval.");
              }
            }

      - name: Skip Two-Key for Non-Sensitive Paths
        if: steps.check-sensitive.outputs.sensitive_touched == 'false'
        run: |
          echo "✅ No sensitive paths touched. Two-Key enforcement not required."
          echo "This PR can proceed with standard review process."
